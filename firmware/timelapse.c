#include <avr/io.h>
#include <util/delay.h>
#include <avr/pgmspace.h>
#include <avr/interrupt.h>
#include "i2c.h"

/*
#include "SSD1306.h"
const uint8_t logo[] PROGMEM = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xc0, 0xc0, 0xc0, 0x40, 0xc0, 0xc0, 0xc0, 0x40, 0xc0, 0xc0, 0x40, 0xc0, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0xe0, 0x70, 0x38, 0x10, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x0c, 0x1f, 0x03, 0x01, 0x00, 0x80, 0x80, 0x80, 0xc0, 0x80, 0x80, 0x80, 0x80, 0x80, 0x01, 0x01, 0x0f, 0x1e, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x30, 0x38, 0x60, 0xe0, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xdb, 0xff, 0x4a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xe0, 0xf8, 0x1c, 0x4e, 0xe7, 0x73, 0x39, 0x1d, 0x09, 0x1d, 0x09, 0x01, 0x01, 0x01, 0x03, 0x07, 0x06, 0x1e, 0x78, 0xf0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xdb, 0xff, 0x48, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xd6, 0xff, 0x29, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x7f, 0xe0, 0xc3, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xc0, 0xea, 0x7f, 0x0b, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xdd, 0xff, 0x44, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x1f, 0x3d, 0x30, 0x60, 0xe0, 0x40, 0xe0, 0x40, 0xe0, 0x40, 0xe0, 0x40, 0xe1, 0x41, 0xe3, 0x47, 0xe6, 0x4e, 0xcc, 0x4c, 0xec, 0x4c, 0xee, 0x44, 0xe7, 0x43, 0xe5, 0x41, 0xe0, 0x40, 0xe0, 0x40, 0xe0, 0x40, 0xe0, 0x40, 0x60, 0x70, 0x30, 0x1e, 0x0f, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  };
*/



static const uint8_t font_glyphs[][39]  = {
{ 0x00, 0x80, 0xf0, 0xf8, 0xfc, 0x3c, 0x1c, 0x3c, 0xfc, 0xf8, 0xf0, 0x80, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0x01, 0x0f, 0x1f, 0x3f, 0x3c, 0x38, 0x3c, 0x3f, 0x1f, 0x0f, 0x01, 0x00 },
{ 0x00, 0x00, 0xc0, 0xe0, 0xf0, 0x78, 0xfc, 0xfc, 0xfc, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3f, 0x3f, 0x3f, 0x3f, 0x00, 0x00, 0x00 },
{ 0x00, 0x10, 0x38, 0x38, 0x1c, 0x1c, 0x1c, 0x3c, 0xfc, 0xf8, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0xe0, 0xf8, 0xfe, 0x3f, 0x1f, 0x07, 0x00, 0x00, 0x00, 0x38, 0x3e, 0x3f, 0x3f, 0x3b, 0x39, 0x38, 0x38, 0x38, 0x38, 0x38, 0x00 },
{ 0x00, 0x18, 0x38, 0x3c, 0x1c, 0x1c, 0x1c, 0x3c, 0xfc, 0xf8, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1c, 0x1c, 0x1c, 0x1c, 0x3f, 0xff, 0xf3, 0xe1, 0xc0, 0x00, 0x00, 0x1c, 0x38, 0x38, 0x38, 0x38, 0x38, 0x3c, 0x1f, 0x1f, 0x0f, 0x03, 0x00 },
{ 0x00, 0x00, 0x00, 0x00, 0xc0, 0xf0, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0x00, 0x00, 0x80, 0xe0, 0xf8, 0xfe, 0x9f, 0x87, 0x81, 0xff, 0xff, 0xff, 0xff, 0x80, 0x80, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x3f, 0x3f, 0x3f, 0x3f, 0x03, 0x03 },
{ 0x00, 0x00, 0xfc, 0xfc, 0xfc, 0x1c, 0x1c, 0x1c, 0x1c, 0x1c, 0x1c, 0x00, 0x00, 0x00, 0x00, 0x0f, 0x0f, 0x0f, 0x0e, 0x0e, 0x1e, 0xfe, 0xfc, 0xf8, 0xe0, 0x00, 0x00, 0x1c, 0x3c, 0x38, 0x38, 0x38, 0x38, 0x3c, 0x1f, 0x1f, 0x0f, 0x01, 0x00 },
{ 0x00, 0x00, 0xe0, 0xf0, 0xf8, 0x78, 0x3c, 0x1c, 0x1c, 0x1c, 0x1c, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xf9, 0x0c, 0x0e, 0x0e, 0xfe, 0xfe, 0xfc, 0xf0, 0x00, 0x00, 0x03, 0x0f, 0x1f, 0x3f, 0x3c, 0x38, 0x38, 0x3f, 0x1f, 0x0f, 0x03, 0x00 },
{ 0x00, 0x1c, 0x1c, 0x1c, 0x1c, 0x1c, 0x1c, 0x9c, 0xfc, 0xfc, 0xfc, 0x1c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xe0, 0xfc, 0xff, 0x7f, 0x0f, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x38, 0x3f, 0x3f, 0x1f, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00 },
{ 0x00, 0xe0, 0xf0, 0xf8, 0xfc, 0x1c, 0x1c, 0x1c, 0xfc, 0xf8, 0xf0, 0xc0, 0x00, 0x00, 0xc0, 0xe3, 0xf7, 0xff, 0x3e, 0x1c, 0x3e, 0xff, 0xf7, 0xe3, 0xc0, 0x00, 0x00, 0x07, 0x1f, 0x1f, 0x3f, 0x38, 0x38, 0x38, 0x3f, 0x1f, 0x1f, 0x07, 0x00 },
{ 0x00, 0xe0, 0xf0, 0xf8, 0xfc, 0x1c, 0x1c, 0x3c, 0xfc, 0xf8, 0xf0, 0x80, 0x00, 0x00, 0x0f, 0x3f, 0x7f, 0x7f, 0x70, 0x70, 0x38, 0xff, 0xff, 0xff, 0x7f, 0x00, 0x00, 0x00, 0x38, 0x38, 0x38, 0x38, 0x3c, 0x1e, 0x1f, 0x0f, 0x03, 0x00, 0x00 },
{ 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x07, 0x07, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3c, 0x3c, 0x3c, 0x3c, 0x00, 0x00, 0x00, 0x00, 0x00 },
};

void draw_time(uint8_t hh,uint8_t mm, uint8_t ss) {
  // _delay_ms(1000);
  SSD1306_DrawGlyph(  12    ,0,13,3,0,font_glyphs[hh/10]);
  SSD1306_DrawGlyph(  25    ,0,13,3,0,font_glyphs[hh%10]);
  SSD1306_DrawGlyph(  38    ,0,13,3,0,font_glyphs[10]);
  SSD1306_DrawGlyph(  51    ,0,13,3,0,font_glyphs[mm/10]);
  SSD1306_DrawGlyph(  64    ,0,13,3,0,font_glyphs[mm%10]);
  SSD1306_DrawGlyph(  77    ,0,13,3,0,font_glyphs[10]);
  SSD1306_DrawGlyph(  90    ,0,13,3,0,font_glyphs[ss/10]);
  SSD1306_DrawGlyph(  103   ,0,13,3,0,font_glyphs[ss%10]);


}
char cnt ;

ISR(TIMER0_OVF_vect){
  cnt++;
  if(cnt>100){
   if((~PIND) & _BV(3)){
    PORTB &= (~_BV(0));
    while(1); // we power off so dont go anywhere else
   } else {
    cnt=0;
    TCCR0 = 0;
   }
  }
}
ISR(INT1_vect){
  TCCR0 |= _BV(CS02)|_BV(CS00); // div 1024 prescalar
  TIMSK |= _BV(TOIE0);
}

int main(void)
{
    
    uint8_t cnt = 0;
    uint8_t hh = 0, mm=0,ss=0;
    SSD1306_Init(); // no need to init. it should be initialized from the boot loader
    SSD1306_Clear(); // no need to init. it should be initialized from the boot loader
    

    DDRD = 0b00100000;
    PORTD = 0b00100000;

    MCUCR |= _BV(ISC11)|_BV(ISC10); // INT1 on rising edge
    GICR |= _BV(INT1);  // enable interrupt
    sei();

    // enable the INT1 to trigger on high
    cnt=0;

    draw_time(0,0,0);

    while(1){
      PORTD ^= 0b00100000;
      _delay_ms(500);
      cnt++;
      if(cnt==2) {
	cnt=0; ss++; if(ss==60) { ss = 0; mm++; if(mm==60) { mm=0; hh++; if (hh==48) { hh = 0; }}}
	if(mm==1) mm=0;
	draw_time(hh,mm,ss);
      }
    }

}
